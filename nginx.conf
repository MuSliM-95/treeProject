user  root;  # пользователь, от имени которого работает Nginx

worker_processes auto;  # количество рабочих процессов Nginx, для маленького проекта 1 достаточно

events {
     worker_connections  1024;  # максимальное количество соединений на процесс
}

http  {
    include /etc/nginx/conf.d/gzip.conf;
    # --- HTTP сервер для редиректа на HTTPS ---
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m; # Она создаёт общую зону памяти, где Nginx будет считать активные соединения.
    limit_req_zone  $binary_remote_addr zone=req_limit_per_ip:10m rate=10r/s;
    limit_req_zone  $binary_remote_addr zone=auth_req_limit:10m rate=5r/s;
    limit_conn_zone $binary_remote_addr zone=auth_conn_limit:10m;

    keepalive_timeout 65s;
    keepalive_requests 1000;


    upstream backend {
        server express:9004;
        keepalive 32;
    }

    upstream frontend_upstream {
        server frontend:3000;
        keepalive 16;
    }

    server {
        listen       80;             # слушаем HTTP порт
        server_name  genealogyhub.ru www.genealogyhub.ru;      # имя сервера
        # root /srv/public;            # корневая папка (не используется из-за редиректа)
        return 301 https://$host$request_uri;  # редирект всех HTTP-запросов на HTTPS
    }

    # --- HTTPS сервер ---
    server {
        listen 443 ssl http2;              # слушаем HTTPS порт

        server_name genealogyhub.ru www.genealogyhub.ru;      # имя сервера

        limit_conn_status 429;
        # root /srv/public;            # корневая папка для статики
        server_tokens off;           # отключаем показ версии Nginx (безопасность)

        # Пути к SSL сертификатам
        ssl_certificate /etc/letsencrypt/live/genealogyhub.ru/fullchain.pem;      # путь к crt файлу
        ssl_certificate_key /etc/letsencrypt/live/genealogyhub.ru/privkey.pem;   # путь к ключу


        location ^~ /api/auth/ {
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;
            

            limit_req zone=auth_req_limit burst=5 nodelay;
            limit_conn auth_conn_limit 5;
        
            client_max_body_size 16k;
        
            proxy_connect_timeout 5s;
            proxy_send_timeout 15s;
            proxy_read_timeout 15s;
        
            limit_except POST {
                return 405;
            }

        
            proxy_pass http://backend;
        }

        location /api/ {
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;

            limit_req zone=req_limit_per_ip burst=10 nodelay;
            limit_conn conn_limit_per_ip 10;  # количество соединений до 15 на каждый уникальный IP-адрес:
            proxy_pass http://backend;  # проксирование на backend
            proxy_set_header Host $host;       # передаём оригинальный хост
            proxy_set_header X-Real-IP $remote_addr;  # передаём IP клиента
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
            proxy_set_header X-Forwarded-Proto https;
        }



        # --- Локация для статики Next.js с кэшированием ---
        location /_next/static/ {
            proxy_pass http://frontend_upstream;
            expires 1y;
            add_header Cache-Control "public, max-age=31536000, immutable";
            access_log off;
        }

        # --- Локация для отдачи статики или fallback на frontend ---
        location / {
            try_files $uri $uri/ @frontend;  # если файл не найден, перенаправляем на internal location @frontend
        }

        # --- Internal location для фронтенда (Next.js) ---
        location @frontend {
            proxy_connect_timeout 5s;
            proxy_read_timeout 60s;

            # Передаём оригинальный IP клиента на Next.js
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # Указываем, что запрос пришёл по HTTPS
            proxy_set_header X-Forwarded-Proto https;
            # Альтернативная запись для некоторых приложений, чтобы они понимали SSL
            proxy_set_header X-Forwarded-Ssl on;
            # Передаём оригинальный хост (например, example.com)
            proxy_set_header Host $http_host;
            # Отключаем автоматические редиректы, чтобы Nginx не менял Location заголовки
            proxy_redirect off;
            # Проксируем все запросы на контейнер frontend:3000 (Next.js)
            proxy_pass http://frontend_upstream;
            # Делает куки безопасными: HttpOnly и Secure
            # proxy_cookie_path / "/; HTTPOnly; Secure";
        }
    }

}